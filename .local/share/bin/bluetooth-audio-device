#!/usr/bin/env bash

set -euo pipefail

json_escape() {
  local s="${1-}"
  s=${s//\\/\\\\}
  s=${s//"/\\"}
  s=${s//$'\n'/ }
  printf '%s' "$s"
}

inspect="$(wpctl inspect @DEFAULT_AUDIO_SINK@ 2>/dev/null || true)"

if [[ -n "$inspect" ]] && grep -q 'device.api = "bluez5"' <<<"$inspect"; then
  name="$(grep -m1 -oP 'node\.description = "\K[^"]+' <<<"$inspect" || true)"
  if [[ -z "$name" ]]; then
    name="$(grep -m1 -oP 'media\.name = "\K[^"]+' <<<"$inspect" || true)"
  fi
fi

if [[ -z "${name-}" ]]; then
  connected="$(bluetoothctl devices Connected 2>/dev/null | head -n 1)"
  if [[ -n "$connected" ]]; then
    name="${connected#Device * }"
  fi
fi

if [[ -z "${name-}" ]]; then
  printf '{"text":"EMPT","class":"disconnected"}\n'
  exit 0
fi

text="$(json_escape "$name")"
tooltip="$(json_escape "Bluetooth: $name")"

printf '{"text":"%s","class":"connected","tooltip":"%s"}\n' "$text" "$tooltip"
