#!/usr/bin/env bash

set -euo pipefail

STEAM_LIBS=(
	/games/steam/steamapps
	~/.steam/steam/steamapps
	~/.local/share/Steam/steamapps
	~/.var/app/com.valvesoftware.Steam/.local/share/Steam/steamapps
)

die() {
	printf '%s\n' "$*" >&2
	exit 1
}

usage() {
	cat <<-EOF
		Usage:
		  parton run [options] <appid> <exe> [args...]
		      Run a Windows executable using game's Proton/wineprefix.

		  parton ls
		      List games with existing wineprefixes.

		Options:
		  --desktop[=WxH]   Run in Wine virtual desktop (default: 1280x720)
		  --proton <path>   Override Proton path (default: auto-detect from Steam)

		Examples:
		  parton run 1888160 "C:/Program Files/Cheat Engine/cheatengine.exe"
		  parton run --desktop 1888160 "/path/to/app.exe"
		  parton run --desktop=1920x1080 1888160 "C:/tools/x64dbg/x64dbg.exe"
	EOF
}

find_in_libs() {
	local relpath=$1
	for lib in "${STEAM_LIBS[@]}"; do
		lib="${lib/#\~/$HOME}"
		if [[ -e "$lib/$relpath" ]]; then
			printf '%s' "$lib/$relpath"
			return 0
		fi
	done
	return 1
}

get_game_name() {
	local appid=$1
	local manifest
	if manifest=$(find_in_libs "appmanifest_$appid.acf"); then
		grep -oP '^\s*"name"\s*"\K[^"]+' "$manifest" && return
	fi
	echo "(unknown)"
}

find_compatdata() {
	local appid=$1
	find_in_libs "compatdata/$appid" || die "No compatdata found for appid $appid"
}

get_configured_proton() {
	local appid=$1
	local config=~/.steam/steam/config/config.vdf

	[[ -f $config ]] || return 1

	local tool_name
	tool_name=$(awk -v id="$appid" '
		/CompatToolMapping/,/^[[:space:]]*}[[:space:]]*$/ {
			if ($1 == "\"" id "\"") { found=1 }
			if (found && $1 == "\"name\"") {
				gsub(/"/, "", $2)
				print $2
				exit
			}
			if (found && /^[[:space:]]*}/) { exit }
		}
	' "$config")

	[[ -n $tool_name ]] || return 1

	local search_name
	case $tool_name in
	proton_experimental) search_name="Proton Experimental" ;;
	proton_hotfix) search_name="Proton Hotfix" ;;
	proton_9) search_name="Proton 9" ;;
	proton_8) search_name="Proton 8" ;;
	*) search_name="${tool_name//_/ }" ;;
	esac

	local manifest installdir
	for lib in "${STEAM_LIBS[@]}"; do
		lib="${lib/#\~/$HOME}"
		for manifest in "$lib"/appmanifest_*.acf; do
			[[ -f $manifest ]] || continue
			if grep -q "\"name\".*\"$search_name\"" "$manifest" 2>/dev/null; then
				installdir=$(grep -oP '^\s*"installdir"\s*"\K[^"]+' "$manifest")
				if [[ -n $installdir && -x "$lib/common/$installdir/proton" ]]; then
					printf '%s' "$lib/common/$installdir/proton"
					return 0
				fi
			fi
		done
	done

	return 1
}

find_default_proton() {
	local proton
	for name in "Proton - Experimental" "Proton Hotfix" "Proton 9"*; do
		if proton=$(find_in_libs "common/$name/proton") && [[ -x $proton ]]; then
			printf '%s' "$proton"
			return 0
		fi
	done

	for lib in "${STEAM_LIBS[@]}"; do
		lib="${lib/#\~/$HOME}"
		for proton in "$lib"/common/Proton*/proton; do
			if [[ -x $proton ]]; then
				printf '%s' "$proton"
				return 0
			fi
		done
	done

	return 1
}

get_proton() {
	local appid=$1
	get_configured_proton "$appid" || find_default_proton || die "No Proton installation found"
}

# List running games by checking wineserver processes
cmd_ls() {
	local pid appid
	for pid in /proc/[0-9]*; do
		[[ -r "$pid/comm" ]] || continue
		[[ $(<"$pid/comm") == "wineserver" ]] || continue
		# Extract SteamAppId from wineserver's environment
		appid=$(tr '\0' '\n' <"$pid/environ" 2>/dev/null | sed -n 's/^SteamAppId=//p')
		[[ -n $appid ]] || continue
		printf '%s\t%s\n' "$appid" "$(get_game_name "$appid")"
	done
}

cmd_run() {
	local use_desktop=0
	local desktop_res="1280x720"
	local proton_override=""

	while [[ $# -gt 0 ]]; do
		case $1 in
		--desktop)
			use_desktop=1
			shift
			;;
		--desktop=*)
			use_desktop=1
			desktop_res="${1#*=}"
			shift
			;;
		--proton)
			proton_override="$2"
			shift 2
			;;
		--proton=*)
			proton_override="${1#*=}"
			shift
			;;
		-*) die "Unknown option: $1" ;;
		*) break ;;
		esac
	done

	[[ $# -ge 2 ]] || die "run requires <appid> <exe>"

	local appid=$1
	shift
	local compatdata proton wine64

	compatdata=$(find_compatdata "$appid")
	proton="${proton_override:-$(get_proton "$appid")}"
	wine64="$(dirname "$proton")/files/bin/wine64"

	[[ -x $wine64 ]] || die "wine64 not found at $wine64"

	export WINEPREFIX="$compatdata/pfx"
	export WINEFSYNC=1
	export STEAM_COMPAT_DATA_PATH="$compatdata"

	if [[ $use_desktop -eq 1 ]]; then
		exec "$wine64" explorer "/desktop=parton,$desktop_res" "$@"
	else
		exec "$wine64" "$@"
	fi
}

main() {
	[[ $# -ge 1 ]] || {
		usage
		exit 1
	}

	local cmd=$1
	shift

	case $cmd in
	ls) cmd_ls ;;
	run) cmd_run "$@" ;;
	-h | --help | help) usage ;;
	*) die "Unknown command: $cmd" ;;
	esac
}

main "$@"
