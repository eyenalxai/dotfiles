#!/usr/bin/env bash

set -euo pipefail

STEAM_LIBS=(
	/games/steam/steamapps
	~/.steam/steam/steamapps
	~/.local/share/Steam/steamapps
	~/.var/app/com.valvesoftware.Steam/.local/share/Steam/steamapps
)

die() {
	printf '%s\n' "$*" >&2
	exit 1
}

usage() {
	cat <<-EOF
		Usage:
		  parton run [options] <appid> <exe> [args...]
		      Run a Windows executable in a running game's Proton context.

		  parton ls
		      List currently running games.

		Options:
		  --desktop[=WxH]   Run in Wine virtual desktop (default: 1280x720)

		Examples:
		  parton run 1888160 "C:/Program Files/Cheat Engine/cheatengine.exe"
		  parton run --desktop 1888160 "/path/to/app.exe"
		  parton run --desktop=1920x1080 1888160 "C:/tools/x64dbg/x64dbg.exe"
	EOF
}

find_in_libs() {
	local relpath=$1
	for lib in "${STEAM_LIBS[@]}"; do
		lib="${lib/#\~/$HOME}"
		if [[ -e "$lib/$relpath" ]]; then
			printf '%s' "$lib/$relpath"
			return 0
		fi
	done
	return 1
}

get_game_name() {
	local appid=$1
	local manifest
	if manifest=$(find_in_libs "appmanifest_$appid.acf"); then
		grep -oP '^\s*"name"\s*"\K[^"]+' "$manifest" && return
	fi
	echo "(unknown)"
}

find_wineserver() {
	local target_appid=$1
	local pid appid
	for pid in /proc/[0-9]*; do
		[[ -r "$pid/comm" ]] || continue
		[[ $(<"$pid/comm") == "wineserver" ]] || continue
		appid=$(tr '\0' '\n' <"$pid/environ" 2>/dev/null | sed -n 's/^SteamAppId=//p')
		if [[ $appid == "$target_appid" ]]; then
			printf '%s' "${pid##*/}"
			return 0
		fi
	done
	return 1
}

get_wine64() {
	local pid=$1
	local wineserver_path
	wineserver_path=$(readlink "/proc/$pid/exe")
	printf '%s' "${wineserver_path%/*}/wine64"
}

get_wineprefix() {
	local pid=$1
	tr '\0' '\n' <"/proc/$pid/environ" | sed -n 's/^WINEPREFIX=//p'
}

cmd_ls() {
	local pid appid
	for pid in /proc/[0-9]*; do
		[[ -r "$pid/comm" ]] || continue
		[[ $(<"$pid/comm") == "wineserver" ]] || continue
		appid=$(tr '\0' '\n' <"$pid/environ" 2>/dev/null | sed -n 's/^SteamAppId=//p')
		[[ -n $appid ]] || continue
		printf '%s\t%s\n' "$appid" "$(get_game_name "$appid")"
	done
}

cmd_run() {
	local use_desktop=0
	local desktop_res="1280x720"

	while [[ $# -gt 0 ]]; do
		case $1 in
		--desktop)
			use_desktop=1
			shift
			;;
		--desktop=*)
			use_desktop=1
			desktop_res="${1#*=}"
			shift
			;;
		-*) die "Unknown option: $1" ;;
		*) break ;;
		esac
	done

	[[ $# -ge 2 ]] || die "run requires <appid> <exe>"

	local appid=$1
	shift
	local pid wine64 wineprefix

	pid=$(find_wineserver "$appid") || die "No running game with appid $appid"
	wine64=$(get_wine64 "$pid")
	wineprefix=$(get_wineprefix "$pid")

	[[ -x $wine64 ]] || die "wine64 not found at $wine64"
	[[ -n $wineprefix ]] || die "Could not determine WINEPREFIX"

	export WINEPREFIX="$wineprefix"
	export WINEFSYNC=1

	if [[ $use_desktop -eq 1 ]]; then
		exec "$wine64" explorer "/desktop=parton,$desktop_res" "$@"
	else
		exec "$wine64" "$@"
	fi
}

main() {
	[[ $# -ge 1 ]] || {
		usage
		exit 1
	}

	local cmd=$1
	shift

	case $cmd in
	ls) cmd_ls ;;
	run) cmd_run "$@" ;;
	-h | --help | help) usage ;;
	*) die "Unknown command: $cmd" ;;
	esac
}

main "$@"
