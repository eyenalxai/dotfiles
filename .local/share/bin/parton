#!/usr/bin/env bash

set -euo pipefail

die() {
	printf '%s\n' "$*" >&2
	exit 1
}

usage() {
	cat <<-EOF
		Usage:
		  parton run [options] <appid> <exe> [args...]
		      Run a Windows executable in a running game's Proton context.

		  parton ls
		      List currently running games.

		Options:
		  --bypass-gamescope[=WxH]   Run on host display in Wine virtual desktop (default: 1280x720)

		Examples:
		  parton run 1888160 "C:/Program Files/Cheat Engine/cheatengine.exe"
		  parton run --bypass-gamescope 1888160 "/path/to/app.exe"
		  parton run --bypass-gamescope=1920x1080 1888160 "C:/tools/x64dbg/x64dbg.exe"
	EOF
}

get_running_games() {
	local pid appid compatdata
	for pid in /proc/[0-9]*; do
		[[ -r "$pid/comm" ]] || continue
		[[ $(<"$pid/comm") == "wineserver" ]] || continue

		local env
		env=$(tr '\0' '\n' <"$pid/environ" 2>/dev/null) || continue
		appid=$(sed -n 's/^SteamAppId=//p' <<<"$env")
		[[ -n $appid ]] || continue
		compatdata=$(sed -n 's/^STEAM_COMPAT_DATA_PATH=//p' <<<"$env")
		printf '%s:%s:%s\n' "${pid##*/}" "$appid" "$compatdata"
	done
}

get_game_name() {
	local compatdata=$1 appid=$2
	local steamapps="${compatdata%/compatdata/*}"
	local manifest="$steamapps/appmanifest_$appid.acf"
	if [[ -f $manifest ]]; then
		grep -oP '^\s*"name"\s*"\K[^"]+' "$manifest" && return
	fi
	echo "(unknown)"
}

get_wineserver_info() {
	local target_appid=$1
	local pid appid compatdata
	for pid in /proc/[0-9]*; do
		[[ -r "$pid/comm" ]] || continue
		[[ $(<"$pid/comm") == "wineserver" ]] || continue
		ENV=$(tr '\0' '\n' <"$pid/environ" 2>/dev/null) || continue
		appid=$(sed -n 's/^SteamAppId=//p' <<<"$ENV")
		if [[ $appid == "$target_appid" ]]; then
			PID="${pid##*/}"
			COMPATDATA=$(sed -n 's/^STEAM_COMPAT_DATA_PATH=//p' <<<"$ENV")
			local wineserver_path
			wineserver_path=$(readlink "/proc/$PID/exe")
			WINE64="${wineserver_path%/*}/wine64"
			return 0
		fi
	done
	return 1
}

export_sync_vars() {
	local env=$1
	local var val
	for var in WINEFSYNC WINEESYNC; do
		val=$(sed -n "s/^$var=//p" <<<"$env")
		[[ -n $val ]] && export "$var=$val"
	done
}

cmd_ls() {
	local pid appid compatdata
	while IFS=: read -r pid appid compatdata; do
		printf '%s\t%s\n' "$appid" "$(get_game_name "$compatdata" "$appid")"
	done < <(get_running_games)
}

cmd_run() {
	local bypass_gamescope=0
	local bypass_res="1280x720"

	while [[ $# -gt 0 ]]; do
		case $1 in
		--bypass-gamescope)
			bypass_gamescope=1
			shift
			;;
		--bypass-gamescope=*)
			bypass_gamescope=1
			bypass_res="${1#*=}"
			shift
			;;
		-*) die "Unknown option: $1" ;;
		*) break ;;
		esac
	done

	[[ $# -ge 2 ]] || die "run requires <appid> <exe>"

	local appid=$1
	shift

	local PID COMPATDATA WINE64 ENV
	get_wineserver_info "$appid" || die "No running game with appid $appid"

	[[ -x $WINE64 ]] || die "wine64 not found at $WINE64"
	[[ -n $COMPATDATA ]] || die "Could not determine STEAM_COMPAT_DATA_PATH"

	export WINEPREFIX="$COMPATDATA/pfx"
	export_sync_vars "$ENV"

	if [[ $bypass_gamescope -eq 1 ]]; then
		exec "$WINE64" explorer "/desktop=parton,$bypass_res" "$@"
	else
		exec "$WINE64" "$@"
	fi
}

main() {
	[[ $# -ge 1 ]] || {
		usage
		exit 1
	}

	local cmd=$1
	shift

	case $cmd in
	ls) cmd_ls ;;
	run) cmd_run "$@" ;;
	-h | --help | help) usage ;;
	*) die "Unknown command: $cmd" ;;
	esac
}

main "$@"
