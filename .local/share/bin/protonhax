#!/usr/bin/env bash

set -euo pipefail

host_wayland_display=${WAYLAND_DISPLAY-}
host_display=${DISPLAY-}
host_xdg_runtime_dir=${XDG_RUNTIME_DIR-}
host_xdg_current_desktop=${XDG_CURRENT_DESKTOP-}
host_xdg_session_desktop=${XDG_SESSION_DESKTOP-}
host_xdg_session_type=${XDG_SESSION_TYPE-}
host_xdg_session_class=${XDG_SESSION_CLASS-}
host_xdg_session_id=${XDG_SESSION_ID-}
host_xdg_session_path=${XDG_SESSION_PATH-}
host_xdg_backend=${XDG_BACKEND-}

phd=${XDG_RUNTIME_DIR:-/run/user/$UID}/protonhax

usage() {
	echo "Usage:"
	echo "protonhax init <cmd>"
	printf "\tShould only be called by Steam with \"protonhax init %%COMMAND%%\"\n"
	echo "protonhax ls"
	printf "\tLists all currently running games\n"
	echo "protonhax run [--no-gamescope[=WxH]] <appid> <cmd>"
	printf "\tRuns <cmd> in the context of <appid> with proton\n"
	printf "\t--no-gamescope runs in a Wine virtual desktop on the host display\n"
	printf "\tOptional resolution (default: 1280x720), e.g. --no-gamescope=1920x1080\n"
	echo "protonhax cmd [--no-gamescope[=WxH]] <appid>"
	printf "\tRuns cmd.exe in the context of <appid>\n"
	echo "protonhax exec [--no-gamescope] <appid> <cmd>"
	printf "\tRuns <cmd> in the context of <appid> (no virtual desktop wrapper)\n"
}

if [[ $# -lt 1 ]]; then
	usage
	exit 1
fi

c=$1
shift

if [[ "$c" == "init" ]]; then
	mkdir -p "$phd/$SteamAppId"
	printf "%s\n" "${@}" | grep -m 1 "/proton" >"$phd/$SteamAppId/exe"
	printf "%s" "$STEAM_COMPAT_DATA_PATH/pfx" >"$phd/$SteamAppId/pfx"
	declare -px >"$phd/$SteamAppId/env"
	"$@"
	ec=$?
	rm -r "${phd:?}/${SteamAppId:?}"
	exit $ec
elif [[ "$c" == "ls" ]]; then
	if [[ -d "$phd" ]]; then
		ls -1 "$phd"
	fi
elif [[ "$c" == "run" ]] || [[ "$c" == "cmd" ]] || [[ "$c" == "exec" ]]; then
	if [[ $# -lt 1 ]]; then
		usage
		exit 1
	fi

	no_gamescope=0
	desktop_res="1280x720"
	while [[ $# -gt 0 ]]; do
		if [[ "$1" == "--no-gamescope" ]]; then
			no_gamescope=1
			shift
			continue
		elif [[ "$1" == --no-gamescope=* ]]; then
			no_gamescope=1
			desktop_res="${1#--no-gamescope=}"
			shift
			continue
		fi
		break
	done

	if [[ $# -lt 1 ]]; then
		usage
		exit 1
	fi
	if [[ ! -d $phd ]]; then
		printf "No app running with appid \"%s\"\n" "$1"
		exit 2
	fi
	if [[ ! -d $phd/$1 ]]; then
		printf "No app running with appid \"%s\"\n" "$1"
		exit 2
	fi
	SteamAppId=$1
	shift

	# shellcheck source=/dev/null
	source "$phd/$SteamAppId/env"

	# Set WINEPREFIX from STEAM_COMPAT_DATA_PATH if not already set
	if [[ -z ${WINEPREFIX-} ]] && [[ -n ${STEAM_COMPAT_DATA_PATH-} ]]; then
		export WINEPREFIX="$STEAM_COMPAT_DATA_PATH/pfx"
	fi

	# Enable fsync to match the running wineserver
	export WINEFSYNC=1

	if [[ $no_gamescope -eq 1 ]]; then
		if [[ -n ${host_xdg_runtime_dir-} ]]; then
			export XDG_RUNTIME_DIR="$host_xdg_runtime_dir"
		fi
		if [[ -n ${host_wayland_display-} ]]; then
			export WAYLAND_DISPLAY="$host_wayland_display"
		else
			unset WAYLAND_DISPLAY
		fi
		if [[ -n ${host_display-} ]]; then
			export DISPLAY="$host_display"
		else
			unset DISPLAY
		fi
		if [[ -n ${host_xdg_current_desktop-} ]]; then
			export XDG_CURRENT_DESKTOP="$host_xdg_current_desktop"
		else
			unset XDG_CURRENT_DESKTOP
		fi
		if [[ -n ${host_xdg_session_desktop-} ]]; then
			export XDG_SESSION_DESKTOP="$host_xdg_session_desktop"
		else
			unset XDG_SESSION_DESKTOP
		fi
		if [[ -n ${host_xdg_session_type-} ]]; then
			export XDG_SESSION_TYPE="$host_xdg_session_type"
		else
			unset XDG_SESSION_TYPE
		fi
		if [[ -n ${host_xdg_session_class-} ]]; then
			export XDG_SESSION_CLASS="$host_xdg_session_class"
		else
			unset XDG_SESSION_CLASS
		fi
		if [[ -n ${host_xdg_session_id-} ]]; then
			export XDG_SESSION_ID="$host_xdg_session_id"
		else
			unset XDG_SESSION_ID
		fi
		if [[ -n ${host_xdg_session_path-} ]]; then
			export XDG_SESSION_PATH="$host_xdg_session_path"
		else
			unset XDG_SESSION_PATH
		fi
		if [[ -n ${host_xdg_backend-} ]]; then
			export XDG_BACKEND="$host_xdg_backend"
		else
			unset XDG_BACKEND
		fi
	fi

	proton_exe="$(cat "$phd/$SteamAppId/exe")"
	proton_dir="$(dirname "$proton_exe")"
	wine64="$proton_dir/files/bin/wine64"

	if [[ "$c" == "run" ]]; then
		if [[ $# -lt 1 ]]; then
			usage
			exit 1
		fi
		if [[ $no_gamescope -eq 1 ]]; then
			exec "$wine64" explorer "/desktop=protonhax,$desktop_res" "$@"
		else
			exec "$proton_exe" run "$@"
		fi
	elif [[ "$c" == "cmd" ]]; then
		cmd_path="$(cat "$phd/$SteamAppId/pfx")/drive_c/windows/system32/cmd.exe"
		if [[ $no_gamescope -eq 1 ]]; then
			exec "$wine64" explorer "/desktop=protonhax,$desktop_res" "$cmd_path"
		else
			exec "$proton_exe" run "$cmd_path"
		fi
	elif [[ "$c" == "exec" ]]; then
		if [[ $# -lt 1 ]]; then
			usage
			exit 1
		fi
		exec "$@"
	fi
else
	printf "Unknown command %s\n" "$c"
	usage
	exit 1
fi
