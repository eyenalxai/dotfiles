#!/usr/bin/env bash

set -euo pipefail

# Simple Walker-based screen recording helper.
# - If a recording is running (gpu-screen-recorder), stop it.
# - Otherwise, show a Walker dmenu to start a new recording
#   with different audio/webcam options.

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}"
USER_DIRS_FILE="$CONFIG_DIR/user-dirs.dirs"

if [[ -f "$USER_DIRS_FILE" ]]; then
  # shellcheck disable=SC1090
  . "$USER_DIRS_FILE"
fi

OUTPUT_DIR="${XDG_VIDEOS_DIR:-$HOME/Videos}"

if [[ ! -d "$OUTPUT_DIR" ]]; then
  if command -v notify-send >/dev/null 2>&1; then
    notify-send "Screen recording directory does not exist" "$OUTPUT_DIR" -u critical -t 3000
  else
    printf 'Screen recording directory does not exist: %s\n' "$OUTPUT_DIR" >&2
  fi
  exit 1
fi

require() {
  if ! command -v "$1" >/dev/null 2>&1; then
    local msg="Required command not found: $1"
    if command -v notify-send >/dev/null 2>&1; then
      notify-send "Screen recording error" "$msg" -u critical -t 5000
    fi
    printf '%s\n' "$msg" >&2
    exit 1
  fi
}

require "walker"
require "gpu-screen-recorder"

start_webcam_overlay() {
  # Optional webcam overlay using ffplay; silently skip if unavailable.
  if ! command -v ffplay >/dev/null 2>&1; then
    return 0
  fi

  pkill -f "ScreenrecordWebcamOverlay" 2>/dev/null || true

  ffplay -f v4l2 -framerate 30 -video_size 640x360 /dev/video0 \
    -window_title "ScreenrecordWebcamOverlay" \
    -noborder \
    -fflags nobuffer -flags low_delay \
    -probesize 32 -analyzeduration 0 \
    -loglevel quiet &
}

stop_webcam_overlay() {
  pkill -f "ScreenrecordWebcamOverlay" 2>/dev/null || true
}

start_recording() {
  local mode="$1"
  local filename
  filename="$OUTPUT_DIR/screenrecording-$(date +'%Y-%m-%d_%H-%M-%S').mp4"

  local audio_devices=""

  case "$mode" in
    desktop* )
      audio_devices="default_output"
      ;;
  esac

  case "$mode" in
    *mic* )
      if [[ -n "$audio_devices" ]]; then
        audio_devices+="|"
      fi
      audio_devices+="default_input"
      ;;
  esac

  local args=()
  if [[ -n "$audio_devices" ]]; then
    args+=("-a" "$audio_devices")
  fi

  if [[ "$mode" == *webcam* ]]; then
    start_webcam_overlay
  fi

  gpu-screen-recorder -w portal -f 60 -fallback-cpu-encoding yes -o "$filename" "${args[@]}" -ac aac &
  local pid=$!

  # Give gpu-screen-recorder a moment to either start or fail
  sleep 0.5
  if ! kill -0 "$pid" >/dev/null 2>&1; then
    # Recorder failed to start (e.g. no default audio device)
    if command -v notify-send >/dev/null 2>&1; then
      notify-send "Screen recording error" "gpu-screen-recorder failed to start. Check audio devices/defaults." -u critical -t 5000
    fi
    stop_webcam_overlay
    return 1
  fi

  if command -v notify-send >/dev/null 2>&1; then
    notify-send "Screen recording started" "$filename" -t 2000
  fi
}

stop_recording() {
  if ! pgrep -f "^gpu-screen-recorder" >/dev/null 2>&1; then
    return 1
  fi

  pkill -SIGINT -f "^gpu-screen-recorder" 2>/dev/null || true

  local count=0
  while pgrep -f "^gpu-screen-recorder" >/dev/null 2>&1 && [[ $count -lt 50 ]]; do
    sleep 0.1
    count=$((count + 1))
  done

  if pgrep -f "^gpu-screen-recorder" >/dev/null 2>&1; then
    pkill -9 -f "^gpu-screen-recorder" 2>/dev/null || true
    if command -v notify-send >/dev/null 2>&1; then
      notify-send "Screen recording error" "Recording process had to be force-killed. Video may be corrupted." -u critical -t 5000
    fi
  else
    if command -v notify-send >/dev/null 2>&1; then
      notify-send "Screen recording saved" "$OUTPUT_DIR" -t 2000
    fi
  fi

  stop_webcam_overlay
}

show_menu() {
  local prompt="Screenrecord"
  local options="With desktop audio
With desktop + microphone audio
With desktop + microphone audio + webcam"

  local selection
  selection=$(printf '%s
' "$options" | walker --dmenu --width 295 --minheight 1 --maxheight 630 --placeholder "$promptâ€¦") || exit 0

  case "$selection" in
    "With desktop audio")
      start_recording "desktop"
      ;;
    "With desktop + microphone audio")
      start_recording "desktop+mic"
      ;;
    "With desktop + microphone audio + webcam")
      start_recording "desktop+mic+webcam"
      ;;
  esac
}

if pgrep -f "^gpu-screen-recorder" >/dev/null 2>&1; then
  stop_recording
  exit 0
fi

show_menu
