#!/usr/bin/env bash

set -euo pipefail

# Walker-based screen recording helper.
# - If a recording is running (gpu-screen-recorder), stop it.
# - Otherwise, show a Walker dmenu with four options:
#   Region, Screen, Region with audio, Screen with audio.

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}"
USER_DIRS_FILE="$CONFIG_DIR/user-dirs.dirs"

if [[ -f "$USER_DIRS_FILE" ]]; then
  # shellcheck disable=SC1090
  . "$USER_DIRS_FILE"
fi

OUTPUT_DIR="${XDG_VIDEOS_DIR:-$HOME/Videos}"

if [[ ! -d "$OUTPUT_DIR" ]]; then
  if command -v notify-send >/dev/null 2>&1; then
    notify-send "Screen recording directory does not exist" "$OUTPUT_DIR" -u critical -t 3000
  else
    printf 'Screen recording directory does not exist: %s\n' "$OUTPUT_DIR" >&2
  fi
  exit 1
fi

require() {
  if ! command -v "$1" >/dev/null 2>&1; then
    local msg="Required command not found: $1"
    if command -v notify-send >/dev/null 2>&1; then
      notify-send "Screen recording error" "$msg" -u critical -t 5000
    fi
    printf '%s\n' "$msg" >&2
    exit 1
  fi
}

require "walker"
require "gpu-screen-recorder"

# Notify waybar’s screen recording indicator to refresh
toggle_screenrecording_indicator() {
  pkill -RTMIN+8 waybar 2>/dev/null || true
}

start_recording() {
  local capture_mode="$1"  # screen, region
  local audio_mode="$2"    # none, desktop

  local filename
  filename="$OUTPUT_DIR/screenrecording-$(date +'%Y-%m-%d_%H-%M-%S').mp4"

  local audio_devices=""

  case "$audio_mode" in
  desktop)
    audio_devices="default_output"
    ;;
  none)
    audio_devices=""
    ;;
  *)
    audio_devices=""
    ;;
  esac

  local args=()
  if [[ -n "$audio_devices" ]]; then
    args+=("-a" "$audio_devices")
  fi

  local w_value
  local region_args=()

  case "$capture_mode" in
  screen)
    w_value="screen"
    ;;
  region)
    require "slurp"
    # slurp format is compatible with gpu-screen-recorder -region
    local region
    if ! region=$(slurp -f "%wx%h+%x+%y"); then
      # Selection cancelled
      return 1
    fi
    w_value="region"
    region_args=(-region "$region")
    ;;
  *)
    return 1
    ;;
  esac

  gpu-screen-recorder -w "$w_value" -f 60 -fallback-cpu-encoding yes "${region_args[@]}" -o "$filename" "${args[@]}" -ac aac &
  local pid=$!

  # Give gpu-screen-recorder a moment to either start or fail
  sleep 0.5
  if ! kill -0 "$pid" >/dev/null 2>&1; then
    # Recorder failed to start (e.g. no default audio device)
    if command -v notify-send >/dev/null 2>&1; then
      notify-send "Screen recording error" "gpu-screen-recorder failed to start. Check audio devices/defaults." -u critical -t 5000
    fi
    return 1
  fi

  toggle_screenrecording_indicator
}

stop_recording() {
  if ! pgrep -f "^gpu-screen-recorder" >/dev/null 2>&1; then
    return 1
  fi

  pkill -SIGINT -f "^gpu-screen-recorder" 2>/dev/null || true

  # Update the waybar indicator immediately
  toggle_screenrecording_indicator

  local count=0
  while pgrep -f "^gpu-screen-recorder" >/dev/null 2>&1 && [[ $count -lt 50 ]]; do
    sleep 0.1
    count=$((count + 1))
  done

  if pgrep -f "^gpu-screen-recorder" >/dev/null 2>&1; then
    pkill -9 -f "^gpu-screen-recorder" 2>/dev/null || true
    if command -v notify-send >/dev/null 2>&1; then
      notify-send "Screen recording error" "Recording process had to be force-killed. Video may be corrupted." -u critical -t 5000
    fi
  else
    if command -v notify-send >/dev/null 2>&1; then
      notify-send "Screen recording saved" "$OUTPUT_DIR" -t 2000
    fi
  fi
}

show_menu() {
  local prompt="Screenrecord"
  local options="Region
Screen
Region with audio
Screen with audio"

  local selection
  selection=$(printf '%s\n' "$options" | walker --dmenu --width 295 --minheight 1 --maxheight 630 --placeholder "$prompt…") || return 1

  case "$selection" in
  "Region")
    printf '%s %s\n' "region" "none"
    ;;
  "Screen")
    printf '%s %s\n' "screen" "none"
    ;;
  "Region with audio")
    printf '%s %s\n' "region" "desktop"
    ;;
  "Screen with audio")
    printf '%s %s\n' "screen" "desktop"
    ;;
  *)
    return 1
    ;;
  esac
}

if pgrep -f "^gpu-screen-recorder" >/dev/null 2>&1; then
  stop_recording
  exit 0
fi

# One-step menu: capture + audio in four presets
selection=$(show_menu) || exit 0

# Split into capture_mode and audio_mode
capture_mode=${selection%% *}
audio_mode=${selection##* }

start_recording "$capture_mode" "$audio_mode"
