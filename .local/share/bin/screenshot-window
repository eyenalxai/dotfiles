#!/usr/bin/env bash

set -euo pipefail

OUTPUT_DIR="$HOME/Pictures/Screenshots"
CACHE_DIR="$HOME/.cache"
STATE_FILE="$CACHE_DIR/screenshot-window-last.txt"

log_error() {
  local msg="$1"
  printf '%s\n' "$msg" >&2
  if command -v notify-send >/dev/null 2>&1; then
    notify-send "Screenshot error" "$msg" -u critical -t 5000
  fi
}

require() {
  if ! command -v "$1" >/dev/null 2>&1; then
    log_error "Required command not found: $1"
    exit 1
  fi
}

notify_success() {
  local mode="$1"
  local file="$2"

  if ! command -v notify-send >/dev/null 2>&1; then
    return 0
  fi

  local body
  case "$mode" in
    window)
      body="Window saved to ~/Pictures/Screenshots"
      ;;
    region)
      body="Region saved to ~/Pictures/Screenshots"
      ;;
    fullscreen)
      body="Fullscreen saved to ~/Pictures/Screenshots"
      ;;
    *)
      body="Screenshot saved to ~/Pictures/Screenshots"
      ;;
  esac

  # Record last screenshot path for mako bindings
  if ! mkdir -p "$CACHE_DIR"; then
    log_error "Failed to create screenshot cache directory: $CACHE_DIR"
  else
    if ! printf '%s\n' "$file" > "$STATE_FILE"; then
      log_error "Failed to write last screenshot path to $STATE_FILE"
    fi
  fi

  notify-send "Screenshot" "$body"
}

require "grim"

# wl-copy is optional; if missing we still take the screenshot
if ! command -v wl-copy >/dev/null 2>&1; then
  log_error "wl-copy not found; screenshot won't be copied to clipboard"
fi

if ! mkdir -p "$OUTPUT_DIR"; then
  log_error "Failed to create screenshot directory: $OUTPUT_DIR"
  exit 1
fi

mode="${1:-window}"

filename="$OUTPUT_DIR/screenshot-$(date +'%Y-%m-%d_%H-%M-%S_grim.png')"

region=""

case "$mode" in
  window)
    require "slurp"
    if command -v hyprctl >/dev/null 2>&1 && command -v jq >/dev/null 2>&1; then
      # Mirror window selection logic from screenrecord-menu
      active_workspaces=$(hyprctl monitors -j | jq -c '[.[].activeWorkspace.id]')
      if ! region=$(hyprctl clients -j | jq --argjson active "$active_workspaces" '.[] | select((.hidden | not) and (.workspace.id as $id | $active | contains([$id]))) | "\(.at[0]),\(.at[1]) \(.size[0])x\(.size[1])"' -r | slurp); then
        # Selection cancelled or slurp failed; treat as non-error
        exit 0
      fi
    else
      if ! region=$(slurp); then
        # Selection cancelled; treat as non-error
        exit 0
      fi
    fi
    ;;
  region)
    require "slurp"
    if ! region=$(slurp); then
      # Selection cancelled; treat as non-error
      exit 0
    fi
    ;;
  fullscreen)
    # No region needed
    ;;
  *)
    log_error "Unknown screenshot mode: $mode (expected window|region|fullscreen)"
    exit 1
    ;;
esac

if [[ "$mode" != "fullscreen" ]]; then
  if [[ -z "$region" ]]; then
    log_error "No region selected for screenshot (empty geometry)"
    exit 1
  fi
  if ! grim -g "$region" - | tee "$filename" | wl-copy 2>/dev/null; then
    log_error "grim failed to capture screenshot (region: $region)"
    exit 1
  fi
else
  if ! grim - | tee "$filename" | wl-copy 2>/dev/null; then
    log_error "grim failed to capture fullscreen screenshot"
    exit 1
  fi
fi

notify_success "$mode" "$filename"
