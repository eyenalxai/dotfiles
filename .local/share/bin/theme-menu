#!/usr/bin/env bash

set -euo pipefail

THEME_DIR="$HOME/.config/theme"
THEMES_DIR="$THEME_DIR/themes"
CURRENT_LINK="$THEME_DIR/current/theme"

error_notify() {
  local msg="$1"
  if command -v notify-send >/dev/null 2>&1; then
    notify-send "Theme menu error" "$msg" -u critical -t 5000
  fi
  printf '%s\n' "$msg" >&2
  exit 1
}

require() {
  if ! command -v "$1" >/dev/null 2>&1; then
    error_notify "Required command not found: $1"
  fi
}

require "walker"

THEME_SET="$HOME/.local/share/bin/theme-set"
if [[ ! -x "$THEME_SET" ]]; then
  error_notify "Required script not found: $THEME_SET"
fi

if [[ ! -d "$THEME_DIR" ]]; then
  error_notify "Theme directory does not exist: ~/.config/theme"
fi

options=""
declare -a display_names=()
declare -a dir_names=()
for path in "$THEMES_DIR"/*; do
  [[ -e "$path" ]] || continue
  name="$(basename "$path")"

  display="$name"
  name_file="$path/name"
  if [[ -f "$name_file" ]]; then
    display="$(<"$name_file")"
    display="${display%%$'\n'*}"
  fi

  display_names+=("$display")
  dir_names+=("$name")
  options+="$display"$'\n'
done

if [[ -z "$options" ]]; then
  error_notify "No themes found in ~/.config/theme/themes."
fi

prompt="Theme"
selection="$(printf '%s\n' "$options" | walker --dmenu --width 295 --minheight 1 --maxheight 630 --placeholder "$promptâ€¦")" || exit 0

# Find the directory corresponding to the selected display name
selected_index=-1
for i in "${!display_names[@]}"; do
  if [[ "${display_names[$i]}" == "$selection" ]]; then
    selected_index="$i"
    break
  fi
done

if [[ "$selected_index" -lt 0 ]]; then
  error_notify "Unknown theme selected: $selection"
fi

TARGET="$THEMES_DIR/${dir_names[$selected_index]}"

if [[ ! -e "$TARGET" ]]; then
  error_notify "Selected theme does not exist: $TARGET"
fi

"$THEME_SET" "${dir_names[$selected_index]}"
