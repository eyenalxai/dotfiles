#!/usr/bin/env bash

set -euo pipefail

THEME_DIR="$HOME/.config/theme"
CURRENT_LINK="$THEME_DIR/current"

error_notify() {
  local msg="$1"
  if command -v notify-send >/dev/null 2>&1; then
    notify-send "Theme menu error" "$msg" -u critical -t 5000
  fi
  printf '%s\n' "$msg" >&2
  exit 1
}

require() {
  if ! command -v "$1" >/dev/null 2>&1; then
    error_notify "Required command not found: $1"
  fi
}

require "walker"
require "uwsm"
require "swaybg"

if [[ ! -d "$THEME_DIR" ]]; then
  error_notify "Theme directory does not exist: ~/.config/theme"
fi

options=""
declare -a display_names=()
declare -a dir_names=()
for path in "$THEME_DIR"/*; do
  [[ -e "$path" ]] || continue
  name="$(basename "$path")"
  [[ "$name" == "current" ]] && continue

  display="$name"
  name_file="$path/name"
  if [[ -f "$name_file" ]]; then
    display="$(<"$name_file")"
    display="${display%%$'\n'*}"
  fi

  display_names+=("$display")
  dir_names+=("$name")
  options+="$display"$'\n'
done

if [[ -z "$options" ]]; then
  error_notify "No themes found in ~/.config/theme (excluding \"current\")."
fi

prompt="Theme"
selection="$(printf '%s\n' "$options" | walker --dmenu --width 295 --minheight 1 --maxheight 630 --placeholder "$promptâ€¦")" || exit 0

# Find the directory corresponding to the selected display name
selected_index=-1
for i in "${!display_names[@]}"; do
  if [[ "${display_names[$i]}" == "$selection" ]]; then
    selected_index="$i"
    break
  fi
done

if [[ "$selected_index" -lt 0 ]]; then
  error_notify "Unknown theme selected: $selection"
fi

TARGET="$THEME_DIR/${dir_names[$selected_index]}"

if [[ ! -e "$TARGET" ]]; then
  error_notify "Selected theme does not exist: $TARGET"
fi

if [[ -L "$CURRENT_LINK" || -e "$CURRENT_LINK" ]]; then
  rm -f "$CURRENT_LINK"
fi

ln -s "$TARGET" "$CURRENT_LINK"

MODE_FILE="$TARGET/mode"
if [[ -f "$MODE_FILE" ]]; then
  mode_content="$(<"$MODE_FILE")"
  mode_lc="${mode_content,,}"
  if [[ "$mode_lc" == *dark* ]]; then
    gsettings set org.gnome.desktop.interface gtk-theme "Adwaita-dark"
    gsettings set org.gnome.desktop.interface color-scheme "prefer-dark"
  elif [[ "$mode_lc" == *light* ]]; then
    gsettings set org.gnome.desktop.interface gtk-theme "Adwaita"
    gsettings set org.gnome.desktop.interface color-scheme "prefer-light"
  fi
fi

ICON_FILE="$TARGET/icons"
if [[ -f "$ICON_FILE" ]]; then
  icon_theme="$(<"$ICON_FILE")"
  icon_theme="${icon_theme%%$'\n'*}"
  if [[ -n "$icon_theme" ]]; then
    gsettings set org.gnome.desktop.interface icon-theme "$icon_theme"
  fi
fi

if [[ ! -x "$HOME/.local/share/bin/code-cursor-theme" ]]; then
  error_notify "Required script not found: ~/.local/share/bin/code-cursor-theme"
fi

~/.local/share/bin/code-cursor-theme

# Restart swaybg with the new background
pkill -x swaybg 2>/dev/null || true
if ! uwsm app -- swaybg -i "$HOME/.config/theme/current/background.webp"; then
  error_notify "Failed to start swaybg via uwsm"
fi

# Reload user units so any systemd user services
# can pick up changed unit files.
if ! systemctl --user daemon-reload; then
  error_notify "Failed to run: systemctl --user daemon-reload"
fi
