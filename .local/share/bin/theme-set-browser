#!/usr/bin/env bash

set -euo pipefail

CHROMIUM_THEME="$HOME/.config/theme/current/theme/chromium.theme"
BIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
THEME_CMD_PRESENT="$BIN_DIR/theme-cmd-present"

if "$THEME_CMD_PRESENT" chromium || "$THEME_CMD_PRESENT" helium-browser || "$THEME_CMD_PRESENT" brave; then
  if [[ -f "$CHROMIUM_THEME" ]]; then
    THEME_RGB_COLOR=$(<"$CHROMIUM_THEME")
    THEME_RGB_COLOR=${THEME_RGB_COLOR//,/ }
    read -r red green blue <<<"$THEME_RGB_COLOR"
    THEME_HEX_COLOR=$(printf '#%02x%02x%02x' "$red" "$green" "$blue")
  else
    THEME_RGB_COLOR="28,32,39"
    THEME_HEX_COLOR="#1c2027"
  fi

  if "$THEME_CMD_PRESENT" chromium; then
    sudo rm -f /etc/chromium/policies/managed/color.json
    chromium --no-startup-window --set-theme-color="$THEME_RGB_COLOR" >/dev/null

    if [[ -f "$HOME/.config/theme/current/theme/light.mode" ]]; then
      chromium --no-startup-window --set-color-scheme="light" >/dev/null
    else
      chromium --no-startup-window --set-color-scheme="dark" >/dev/null
    fi
  fi

  if "$THEME_CMD_PRESENT" brave; then
    echo "{\"BrowserThemeColor\": \"$THEME_HEX_COLOR\"}" | sudo tee "/etc/brave/policies/managed/color.json" >/dev/null
    brave --refresh-platform-policy --no-startup-window >/dev/null
  fi
fi
