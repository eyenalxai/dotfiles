#!/usr/bin/env bash

set -euo pipefail

USER_TEMPLATES_DIR="$HOME/.config/theme/themed"
NEXT_THEME_DIR="$HOME/.config/theme/current/next-theme"
COLORS_FILE="$NEXT_THEME_DIR/colors.toml"

TEMPLATES_DIR=""
if [[ -n "${THEME_PATH:-}" ]]; then
  TEMPLATES_DIR="$THEME_PATH/default/themed"
elif [[ -f "$NEXT_THEME_DIR/theme.name" ]]; then
  current_theme=$(<"$NEXT_THEME_DIR/theme.name")
  if [[ -n "$current_theme" ]]; then
    TEMPLATES_DIR="$HOME/.config/theme/themes/$current_theme/default/themed"
  fi
elif [[ -f "$HOME/.config/theme/current/theme.name" ]]; then
  current_theme=$(<"$HOME/.config/theme/current/theme.name")
  if [[ -n "$current_theme" ]]; then
    TEMPLATES_DIR="$HOME/.config/theme/themes/$current_theme/default/themed"
  fi
fi

hex_to_rgb() {
  local hex="${1#\#}"
  printf "%d,%d,%d" "0x${hex:0:2}" "0x${hex:2:2}" "0x${hex:4:2}"
}

if [[ -f "$COLORS_FILE" ]]; then
  sed_script=$(mktemp)

  sed 's/=/:/' "$COLORS_FILE" | yq -r 'to_entries[] | "s|{{ \(.key) }}|\(.value)|g", "s|{{ \(.key)_strip }}|\(.value | sub("^#";""))|g"' > "$sed_script"

  while IFS='=' read -r key value; do
    key=$(echo "$key" | xargs)
    value=$(echo "$value" | xargs | tr -d '"')
    if [[ $value =~ ^# ]]; then
      rgb=$(hex_to_rgb "$value")
      echo "s|{{ ${key}_rgb }}|${rgb}|g" >> "$sed_script"
    fi
  done < "$COLORS_FILE"

  shopt -s nullglob

  for tpl in "$USER_TEMPLATES_DIR"/*.tpl ${TEMPLATES_DIR:+"$TEMPLATES_DIR"/*.tpl}; do
    filename=$(basename "$tpl" .tpl)
    output_path="$NEXT_THEME_DIR/$filename"

    if [[ ! -f "$output_path" ]]; then
      sed -f "$sed_script" "$tpl" > "$output_path"
    fi
  done

  rm "$sed_script"
fi
