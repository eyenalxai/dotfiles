#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage: $(basename "$0") up|down|mute" >&2
  exit 2
}

is_muted() {
  local mute
  mute="$(pamixer --get-mute 2>/dev/null || true)"
  [[ "$mute" == "true" ]]
}

notify_volume() {
  if is_muted; then
    notify-send -r 9991 "Volume" "Muted"
  else
    notify-send -r 9991 "Volume" "$(pamixer --get-volume-human)"
  fi
}

if [[ $# -ne 1 ]]; then
  usage
fi

cmd="$1"
case "$cmd" in
  up|down)
    v="$(pamixer --get-volume)"
    r=$((v % 5))

    if [[ "$cmd" == "up" ]]; then
      if [[ "$r" -eq 0 ]]; then
        n=$((v + 5))
      else
        n=$((v + (5 - r)))
      fi
    else
      if [[ "$r" -eq 0 ]]; then
        n=$((v - 5))
      else
        n=$((v - r))
      fi
    fi

    if [[ "$n" -gt 100 ]]; then
      n=100
    elif [[ "$n" -lt 0 ]]; then
      n=0
    fi

    pamixer --set-volume "$n"
    pamixer --unmute >/dev/null 2>&1 || true
    notify_volume
    ;;

  mute|toggle-mute)
    pamixer -t
    notify_volume
    ;;

  *)
    usage
    ;;
esac
