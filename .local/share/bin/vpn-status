#!/usr/bin/env bash
set -euo pipefail

VPN_CLIENTS_DEFAULT=(
  "THR:throne-tun"
  "AMN:amn0"
)
VPN_CLIENTS_RAW="${VPN_CLIENTS:-}"

ROUTE_TABLE="${THRONE_ROUTE_TABLE:-2022}"
FWMARK="${THRONE_FWMARK:-0x2023}"

usage() {
  cat <<'EOF'
Usage: vpn-status [--details] [--json] [--waybar]

Checks whether known VPN TUN interfaces are active.

Heuristics:
- Interface exists and is UP
- Optional Throne-specific policy routes/rules also checked

Exit codes:
  0  active
  1  inactive
  2  unknown/error

Env overrides:
  VPN_CLIENTS (comma-separated CODE:IFACE entries)
  THRONE_ROUTE_TABLE, THRONE_FWMARK
EOF
}

want_details=0
want_json=0
want_waybar=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) usage; exit 0 ;;
    --details) want_details=1; shift ;;
    --json) want_json=1; shift ;;
    --waybar) want_waybar=1; shift ;;
    *) echo "Unknown arg: $1" >&2; usage >&2; exit 2 ;;
  esac
done

have_ip() {
  command -v ip >/dev/null 2>&1
}

link_exists() {
  ip link show dev "$1" >/dev/null 2>&1
}

link_is_up() {
  ip -o link show dev "$1" 2>/dev/null | grep -Eq "<([^>]*,)?UP(,|>)"
}

table_default_via_tun() {
  ip route show table "$ROUTE_TABLE" 2>/dev/null | grep -Eq "^default .* dev ${1}([[:space:]]|$)"
}

rule_points_to_table() {
  ip rule show 2>/dev/null | grep -Eq "fwmark ${FWMARK}.*lookup ${ROUTE_TABLE}"
}

core_running() {
  pgrep -fa '/usr/lib/throne/(Core|Throne)' >/dev/null 2>&1
}

parse_clients() {
  local -a entries=()
  local raw="$1"
  local IFS=','
  if [[ -n "$raw" ]]; then
    read -ra entries <<<"$raw"
  else
    entries=("${VPN_CLIENTS_DEFAULT[@]}")
  fi
  printf '%s\n' "${entries[@]}"
}

active_clients=()
unknown_clients=()
status="unknown"

if ! have_ip; then
  status="unknown"
else
  while IFS= read -r entry; do
    [[ -z "$entry" ]] && continue
    code="${entry%%:*}"
    iface="${entry#*:}"
    if [[ -z "$code" || -z "$iface" || "$entry" == "$code" ]]; then
      unknown_clients+=("${entry:-unknown}")
      continue
    fi

    if link_exists "$iface"; then
      if link_is_up "$iface"; then
        active_clients+=("$code")
      else
        unknown_clients+=("$code")
      fi
    fi
  done < <(parse_clients "$VPN_CLIENTS_RAW")

  if [[ ${#active_clients[@]} -gt 0 ]]; then
    status="active"
  elif [[ ${#unknown_clients[@]} -gt 0 ]]; then
    status="unknown"
  else
    status="inactive"
  fi
fi

if [[ ${#active_clients[@]} -eq 1 && "${active_clients[0]}" == "THR" ]]; then
  if table_default_via_tun "throne-tun" || rule_points_to_table || core_running; then
    status="active"
  else
    status="inactive"
    active_clients=()
  fi
fi

if [[ "$want_waybar" -eq 1 ]]; then
  # Waybar JSON output (no jq dependency).
  text="OFF"
  tooltip="VPN inactive"

  if [[ ${#active_clients[@]} -gt 1 ]]; then
    text="MULT"
    tooltip="Multiple VPNs active: ${active_clients[*]}"
  elif [[ ${#active_clients[@]} -eq 1 ]]; then
    text="${active_clients[0]}"
    tooltip="VPN active: ${active_clients[0]}"
  else
    case "$status" in
      inactive) text="OFF"; tooltip="VPN inactive" ;;
      *) text="UNK"; tooltip="VPN status unknown" ;;
    esac
  fi

  printf '{"text":"%s","tooltip":"%s"}\n' "$text" "$tooltip"
elif [[ "$want_json" -eq 1 ]]; then
  # Minimal JSON without jq dependency.
  active_list="${active_clients[*]}"
  printf '{"status":"%s","active":"%s","table":%s,"fwmark":"%s"}\n' "$status" "$active_list" "$ROUTE_TABLE" "$FWMARK"
else
  echo "$status"
fi

if [[ "$want_details" -eq 1 ]]; then
  echo "clients=${VPN_CLIENTS_RAW:-default}" >&2
  echo "route_table=$ROUTE_TABLE" >&2
  echo "fwmark=$FWMARK" >&2
  if [[ ${#active_clients[@]} -gt 0 ]]; then
    printf 'active=%s\n' "${active_clients[*]}" >&2
  fi
  if [[ ${#unknown_clients[@]} -gt 0 ]]; then
    printf 'unknown=%s\n' "${unknown_clients[*]}" >&2
  fi
  for entry in $(parse_clients "$VPN_CLIENTS_RAW"); do
    iface="${entry#*:}"
    [[ -n "$iface" ]] && ip -o link show dev "$iface" 2>/dev/null || true
  done
  ip route show table "$ROUTE_TABLE" 2>/dev/null || true
  ip rule show 2>/dev/null | grep -E "fwmark ${FWMARK}|lookup ${ROUTE_TABLE}" || true
fi

if [[ ${#active_clients[@]} -gt 0 ]]; then
  exit 0
fi

case "$status" in
  inactive) exit 1 ;;
  *) exit 2 ;;
esac
